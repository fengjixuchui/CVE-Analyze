{"TTP_id": "enterprise-TA0005-T1564-T1564.004", "TTP_name": "NTFS File Attributes", "Description": "Adversaries may use NTFS file attributes to hide their malicious data in order to evade detection. Every New Technology File System (NTFS) formatted partition contains a Master File Table (MFT) that maintains a record for every file/directory on the partition. [1] Within MFT entries are file attributes, [2] such as Extended Attributes (EA) and Data [known as Alternate Data Streams (ADSs) when more than one Data attribute is present], that can be used to store arbitrary data (and even complete files). [1] [3] [4] [5]Adversaries may store malicious data or binaries in file attribute metadata instead of directly in files. This may be done to evade some defenses, such as static indicator scanning tools and anti-virus. [6] [4]", "Property": {"ID": "T1564.004", "Sub-technique of": "T1564", "Tactic": "Defense Evasion", "Platforms": "Windows", "System Requirements": "NTFS partitioned hard drive", "Defense Bypassed": "Anti-virus, Host forensic analysis, Signature-based detection", "Contributors": "Oddvar Moe, @oddvarmoe; Red Canary", "Version": "1.0", "Created": "13 March 2020", "Last Modified": "29 March 2020"}, "Examples": {"S0504": ["https://attack.mitre.org/software/S0504", "Anchor", "Anchor has used NTFS to hide files.[7]"], "G0050": ["https://attack.mitre.org/groups/G0050", "APT32", "APT32 used NTFS alternate data streams to hide their payloads.[8]"], "S0373": ["https://attack.mitre.org/software/S0373", "Astaroth", "Astaroth can abuse alternate data streams (ADS) to store content for malicious payloads.[9]"], "S0570": ["https://attack.mitre.org/software/S0570", "BitPaymer", "BitPaymer has copied itself to the :bin alternate data stream of a newly created file.[10]"], "S0404": ["https://attack.mitre.org/software/S0404", "esentutl", "esentutl can be used to read and write alternate data streams.[11]"], "S0361": ["https://attack.mitre.org/software/S0361", "Expand", "Expand can be used to download or copy a file into an alternate data stream.[12]"], "S0168": ["https://attack.mitre.org/software/S0168", "Gazer", "Gazer stores configuration items in alternate data streams (ADSs) if the Registry is not accessible.[13]"], "S0397": ["https://attack.mitre.org/software/S0397", "LoJax", "LoJax has loaded an embedded NTFS DXE driver to be able to access and write to NTFS partitions.[14]"], "S0139": ["https://attack.mitre.org/software/S0139", "PowerDuke", "PowerDuke hides many of its backdoor payloads in an alternate data stream (ADS).[15]"], "S0145": ["https://attack.mitre.org/software/S0145", "POWERSOURCE", "If the victim is using PowerShell 3.0 or later, POWERSOURCE writes its decoded payload to an alternate data stream (ADS) named kernel32.dll that is saved in %PROGRAMDATA%\\Windows\\.[16]"], "S0019": ["https://attack.mitre.org/software/S0019", "Regin", "The Regin malware platform uses Extended Attributes to store encrypted executables.[17]"], "S0476": ["https://attack.mitre.org/software/S0476", "Valak", "Valak has the ability save and execute files as alternate data streams (ADS).[18][19][20]"], "S0612": ["https://attack.mitre.org/software/S0612", "WastedLocker", "WastedLocker has the ability to save and execute files as an alternate data stream (ADS).[21]"], "S0027": ["https://attack.mitre.org/software/S0027", "Zeroaccess", "Some variants of the Zeroaccess Trojan have been known to store data in Extended Attributes.[22]"]}, "Mitigation": {"M1022": ["https://attack.mitre.org/mitigations/M1022", "Restrict File and Directory Permissions", "Consider adjusting read and write permissions for NTFS EA, though this should be tested to ensure routine OS operations are not impeded. [23]"]}, "Detection": {"Command Execution": ["The Streams tool of Sysinternals can be used to uncover files with ADSs. The dir /r command can also be used to display ADSs. [24] Many PowerShell commands (such as Get-Item, Set-Item, Remove-Item, and Get-ChildItem) can also accept a -stream parameter to interact with ADSs. [4] [5]", "DS0017", "https://attack.mitre.org/datasources/DS0017", "Command"], "File Metadata": ["Monitor for contextual data about a file, which may include information such as name, the content (ex: signature, headers, or data/media), user/ower, permissions, may use NTFS file attributes to hide their malicious data in order to evade detection. Forensic techniques exist to identify information stored in NTFS EA. [6]", "DS0022", "https://attack.mitre.org/datasources/DS0022", "File"], "File Modification": ["There are many ways to create and interact with ADSs using Windows utilities. Monitor for operations (execution, copies, etc.) with file names that contain colons. This syntax (ex: file.ext:ads[.ext]) is commonly associated with ADSs. [5] [25] [26] For a more exhaustive list of utilities that can be used to execute and create ADSs, see https://gist.github.com/api0cradle/cdd2d0d0ec9abb686f0e89306e277b8f.", "", "", ""], "OS API Execution": ["Monitor calls to the ZwSetEaFile and ZwQueryEaFile Windows API functions as well as binaries used to interact with EA, [25] [26] and consider regularly scanning for the presence of modified information. [1]", "DS0009", "https://attack.mitre.org/datasources/DS0009", "Process"]}}
