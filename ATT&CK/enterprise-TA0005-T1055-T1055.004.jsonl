{"TTP_id": "enterprise-TA0005-T1055-T1055.004", "TTP_name": "Asynchronous Procedure Call", "Description": "Adversaries may inject malicious code into processes via the asynchronous procedure call (APC) queue in order to evade process-based defenses as well as possibly elevate privileges. APC injection is a method of executing arbitrary code in the address space of a separate live process.APC injection is commonly performed by attaching malicious code to the APC Queue [1] of a process's thread. Queued APC functions are executed when the thread enters an alterable state.[1] A handle to an existing victim process is first created with native Windows API calls such as OpenThread. At this point QueueUserAPC can be used to invoke a function (such as LoadLibrayA pointing to a malicious DLL).A variation of APC injection, dubbed \"Early Bird injection\", involves creating a suspended process in which malicious code can be written and executed before the process' entry point (and potentially subsequent anti-malware hooks) via an APC. [2] AtomBombing [3] is another variation that utilizes APCs to invoke malicious code previously written to the global atom table.[4]Running code in the context of another process may allow access to the process's memory, system/network resources, and possibly elevated privileges. Execution via APC injection may also evade detection from security products since the execution is masked under a legitimate process.", "Property": {"ID": "T1055.004", "Sub-technique of": "T1055", "Tactics": "Defense Evasion, Privilege Escalation", "Platforms": "Windows", "Defense Bypassed": "Anti-virus, Application control", "Version": "1.1", "Created": "14 January 2020", "Last Modified": "18 October 2021"}, "Examples": {"S0438": ["https://attack.mitre.org/software/S0438", "Attor", "Attor performs the injection by attaching its code into the APC queue using NtQueueApcThread API.[5]"], "S0484": ["https://attack.mitre.org/software/S0484", "Carberp", "Carberp has queued an APC routine to explorer.exe by calling ZwQueueApcThread.[6]"], "G0061": ["https://attack.mitre.org/groups/G0061", "FIN8", "FIN8 has injected malicious code into a new svchost.exe process.[7]"], "S0483": ["https://attack.mitre.org/software/S0483", "IcedID", "IcedID has used ZwQueueApcThread to inject itself into remote processes.[8]"], "S0260": ["https://attack.mitre.org/software/S0260", "InvisiMole", "InvisiMole can inject its code into a trusted process via the APC queue.[9]"], "S0517": ["https://attack.mitre.org/software/S0517", "Pillowmint", "Pillowmint has used the NtQueueApcThread syscall to inject code into svchost.exe.[10]"], "S0199": ["https://attack.mitre.org/software/S0199", "TURNEDUP", "TURNEDUP is capable of injecting code into the APC queue of a created Rundll32 process as part of an \"Early Bird injection.\"[2]"]}, "Mitigation": {"M1040": ["https://attack.mitre.org/mitigations/M1040", "Behavior Prevention on Endpoint", "Some endpoint security solutions can be configured to block some types of process injection based on common sequences of behavior that occur during the injection process."]}, "Detection": {"OS API Execution": ["Monitoring Windows API calls indicative of the various types of code injection may generate a significant amount of data and may not be directly useful for defense unless collected under specific circumstances for known bad sequences of calls, since benign use of API functions may be common and difficult to distinguish from malicious behavior. Windows API calls such as SuspendThread/SetThreadContext/ResumeThread, QueueUserAPC/NtQueueApcThread, and those that can be used to modify memory within another process, such as VirtualAllocEx/WriteProcessMemory, may be used for this technique.[11]", "DS0009", "https://attack.mitre.org/datasources/DS0009", "Process"], "Process Access": ["Monitor for processes being viewed that may inject malicious code into processes via the asynchronous procedure call (APC) queue in order to evade process-based defenses as well as possibly elevate privileges.", "", "", ""], "Process Modification": ["Monitor for changes made to processes that may inject malicious code into processes via the asynchronous procedure call (APC) queue in order to evade process-based defenses as well as possibly elevate privileges.", "", "", ""]}}
