{"TTP_id": "enterprise-TA0003-T1574-T1574.001", "TTP_name": "DLL Search Order Hijacking", "Description": "Adversaries may execute their own malicious payloads by hijacking the search order used to load DLLs. Windows systems use a common method to look for required DLLs to load into a program. [1][2] Hijacking DLL loads may be for the purpose of establishing persistence as well as elevating privileges and/or evading restrictions on file execution.There are many ways an adversary can hijack DLL loads. Adversaries may plant trojan dynamic-link library files (DLLs) in a directory that will be searched before the location of a legitimate library that will be requested by a program, causing Windows to load their malicious library when it is called for by the victim program. Adversaries may also perform DLL preloading, also called binary planting attacks, [3] by placing a malicious DLL with the same name as an ambiguously specified DLL in a location that Windows searches before the legitimate DLL. Often this location is the current working directory of the program.[4] Remote DLL preloading attacks occur when a program sets its current directory to a remote location such as a Web share before loading a DLL. [5]Adversaries may also directly modify the search order via DLL redirection, which after being enabled (in the Registry and creation of a redirection file) may cause a program to load a different DLL.[6][7][8]If a search order-vulnerable program is configured to run at a higher privilege level, then the adversary-controlled DLL that is loaded will also be executed at the higher level. In this case, the technique could be used for privilege escalation from user to administrator or SYSTEM or from administrator to SYSTEM, depending on the program. Programs that fall victim to path hijacking may appear to behave normally because malicious DLLs may be configured to also load the legitimate DLLs they were meant to replace.", "Property": {"ID": "T1574.001", "Sub-technique of": "T1574", "Tactics": "Persistence, Privilege Escalation, Defense Evasion", "Platforms": "Windows", "CAPEC ID": "CAPEC-471", "Contributors": "Stefan Kanthak; Travis Smith, Tripwire", "Version": "1.1", "Created": "13 March 2020", "Last Modified": "26 April 2021"}, "Examples": {"G0096": ["https://attack.mitre.org/groups/G0096", "APT41", "APT41 has used search order hijacking to execute malicious payloads, such as Winnti RAT.[9]"], "G0143": ["https://attack.mitre.org/groups/G0143", "Aquatic Panda", "Aquatic Panda has used DLL search-order hijacking to load exe, dll, and dat files into memory.[10]"], "S0373": ["https://attack.mitre.org/software/S0373", "Astaroth", "Astaroth can launch itself via DLL Search Order Hijacking.[11]"], "G0135": ["https://attack.mitre.org/groups/G0135", "BackdoorDiplomacy", "BackdoorDiplomacy has executed DLL search order hijacking.[12]"], "S0415": ["https://attack.mitre.org/software/S0415", "BOOSTWRITE", "BOOSTWRITE has exploited the loading of the legitimate Dwrite.dll file by actually loading the gdi library, which then loads the gdiplus library and ultimately loads the local Dwrite dll.[13]"], "S0631": ["https://attack.mitre.org/software/S0631", "Chaes", "Chaes has used search order hijacking to load a malicious DLL.[14]"], "S0538": ["https://attack.mitre.org/software/S0538", "Crutch", "Crutch can persist via DLL search order hijacking on Google Chrome, Mozilla Firefox, or Microsoft OneDrive.[15]"], "S0134": ["https://attack.mitre.org/software/S0134", "Downdelph", "Downdelph uses search order hijacking of the Windows executable sysprep.exe to escalate privileges.[16]"], "S0363": ["https://attack.mitre.org/software/S0363", "Empire", "Empire contains modules that can discover and exploit various DLL hijacking opportunities.[17]"], "G0120": ["https://attack.mitre.org/groups/G0120", "Evilnum", "Evilnum has used the malware variant, TerraTV, to load a malicious DLL placed in the TeamViewer directory, instead of the original Windows DLL located in a system folder.[18]"], "S0182": ["https://attack.mitre.org/software/S0182", "FinFisher", "A FinFisher variant uses DLL search order hijacking.[19][20]"], "S0661": ["https://attack.mitre.org/software/S0661", "FoggyWeb", "FoggyWeb's loader has used DLL Search Order Hijacking to load malicious code instead of the legitimate version.dll during the Microsoft.IdentityServer.ServiceHost.exe execution process.[21]"], "S0009": ["https://attack.mitre.org/software/S0009", "Hikit", "Hikit has used DLL Search Order Hijacking to load oci.dll as a persistence mechanism.[22]"], "S0070": ["https://attack.mitre.org/software/S0070", "HTTPBrowser", "HTTPBrowser abuses the Windows DLL load order by using a legitimate Symantec anti-virus binary, VPDN_LU.exe, to load a malicious DLL that mimics a legitimate Symantec DLL, navlu.dll.[23]"], "S0260": ["https://attack.mitre.org/software/S0260", "InvisiMole", "InvisiMole can be launched by using DLL search order hijacking in which the wrapper DLL is placed in the same folder as explorer.exe and loaded during startup into the Windows Explorer process instead of the legitimate library.[24]"], "S0530": ["https://attack.mitre.org/software/S0530", "Melcoz", "Melcoz can use DLL hijacking to bypass security controls.[11]"], "G0045": ["https://attack.mitre.org/groups/G0045", "menuPass", "menuPass has used DLL search order hijacking.[25]"], "S0280": ["https://attack.mitre.org/software/S0280", "MirageFox", "MirageFox is likely loaded via DLL hijacking into a legitimate McAfee binary.[26]"], "S0013": ["https://attack.mitre.org/software/S0013", "PlugX", "PlugX has the ability to use DLL search order hijacking for installation on targeted systems.[27]"], "S0194": ["https://attack.mitre.org/software/S0194", "PowerSploit", "PowerSploit contains a collection of Privesc-PowerUp modules that can discover and exploit DLL hijacking opportunities in services and processes.[28][29]"], "S0113": ["https://attack.mitre.org/software/S0113", "Prikormka", "Prikormka uses DLL search order hijacking for persistence by saving itself as ntshrui.dll to the Windows directory so it will load before the legitimate ntshrui.dll saved in the System32 subdirectory.[30]"], "S0458": ["https://attack.mitre.org/software/S0458", "Ramsay", "Ramsay can hijack outdated Windows application dependencies with malicious versions of its own DLL payload.[31]"], "S0153": ["https://attack.mitre.org/software/S0153", "RedLeaves", "RedLeaves is launched through use of DLL search order hijacking to load a malicious dll.[32]"], "G0048": ["https://attack.mitre.org/groups/G0048", "RTM", "RTM has used search order hijacking to force TeamViewer to load a malicious DLL.[33]"], "G0027": ["https://attack.mitre.org/groups/G0027", "Threat Group-3390", "Threat Group-3390 has performed DLL search order hijacking to execute their payload.[34]"], "G0131": ["https://attack.mitre.org/groups/G0131", "Tonto Team", "Tonto Team abuses a legitimate and signed Microsoft executable to launch a malicious DLL.[35]"], "S0612": ["https://attack.mitre.org/software/S0612", "WastedLocker", "WastedLocker has performed DLL hijacking before execution.[36]"], "S0109": ["https://attack.mitre.org/software/S0109", "WEBC2", "Variants of WEBC2 achieve persistence by using DLL search order hijacking, usually by copying the DLL file to %SYSTEMROOT% (C:\\WINDOWS\\ntshrui.dll).[37]"], "G0107": ["https://attack.mitre.org/groups/G0107", "Whitefly", "Whitefly has used search order hijacking to run the loader Vcrodat.[38]"]}, "Mitigation": {"M1047": ["https://attack.mitre.org/mitigations/M1047", "Audit", "Use auditing tools capable of detecting DLL search order hijacking opportunities on systems within an enterprise and correct them. Toolkits like the PowerSploit framework contain PowerUp modules that can be used to explore systems for DLL hijacking weaknesses.[39]Use the program sxstrace.exe that is included with Windows along with manual inspection to check manifest files for side-by-side problems in software.[40]"], "M1038": ["https://attack.mitre.org/mitigations/M1038", "Execution Prevention", "Adversaries may use new DLLs to execute this technique. Identify and block potentially malicious software executed through search order hijacking by using application control solutions capable of blocking DLLs loaded by legitimate software."], "M1044": ["https://attack.mitre.org/mitigations/M1044", "Restrict Library Loading", "Disallow loading of remote DLLs. This is included by default in Windows Server 2012+ and is available by patch for XP+ and Server 2003+.Enable Safe DLL Search Mode to force search for system DLLs in directories with greater restrictions (e.g. %SYSTEMROOT%)to be used before local directory DLLs (e.g. a user's home directory)The Safe DLL Search Mode can be enabled via Group Policy at Computer Configuration > [Policies] > Administrative Templates > MSS (Legacy): MSS: (SafeDllSearchMode) Enable Safe DLL search mode. The associated Windows Registry key for this is located at HKLM\\SYSTEM\\CurrentControlSet\\Control\\Session Manager\\SafeDLLSearchMode[41][1]"]}, "Detection": {"File Creation": ["Monitor newly constructed .manifest and .local redirection files that do not correlate with software updates.", "DS0022", "https://attack.mitre.org/datasources/DS0022", "File"], "File Modification": ["Monitor for changed made to .manifest/.local redirection files, or file systems for moving, renaming, replacing, or modifying DLLs. Changes in the set of DLLs that are loaded by a process (compared with past behavior) that do not correlate with known software, patches, etc., are suspicious.", "", "", ""], "Module Load": ["Monitor DLLs loaded into a process and detect DLLs that have the same file name but abnormal paths.", "DS0011", "https://attack.mitre.org/datasources/DS0011", "Module"]}}
